#!/bin/bash

log () {
  echo -e "$@" >&2
}

usage () {
  if [ -n "$*" ]; then 
    log "$*"; 
  fi

  log "Usage: $0 list" 
  log "       $0 status [--strip] [--no-strip]" 
  log "       $0 connect [--wait] <VPN>" 
  log "       $0 disconnect [VPN]" 
  log "       $0 quit" 

  exit 1
}

if [ "$#" -eq 0 ]; then
  usage
fi

DIVIDER=${TUNBLKCTL_DIVIDER:-1024}
LIB_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )/../libexec"

osascript () {
  /usr/bin/osascript "$LIB_DIR/$1.applescript" "${@:2}"
}

if ! osascript bundleid &> /dev/null ; then
  log "Couldn't find Tunnelblick. Is it installed?"
  exit 2
fi

command="$1"
shift

case "$command" in
  list|ls)
    osascript status 2>&1 | cut -f1 | ([ -t 1 ] && column || cat)
    ;;
  status|st)
    if ! { [ -t 1 ] && [[ $* != *'--strip'* ]] \
           || [[ $* == *'--no-strip'* ]]; } then
      strip=yes
    fi
    
    header="CONFIGURATION\tSTATUS\tIN\tOUT"
    if [[ "$TUNBLKCTL_EXT" =~ on|true|yes ]]; then
      header="$header\tAUTOCONNECT"
    fi

    tabs=${header//[^\t]}
    columns=$(( ${#tabs} + 1 ))

    ([ -z "$strip" ] && echo -e $header; osascript status 2>&1) \
      |  cut -f "1-$columns" \
      | ([ -z "$strip" ] \
          && awk -v FS='\t' -v OFS='\t' -v div="$DIVIDER" -f "$LIB_DIR/numfmt.awk" \
            | column -t -s $'\t' \
          || cat) 
    ;;
  connect|con)
    if [ "$1" = '--wait' ] && [ -n "$2" ]; then
      (osascript connect "$2" && osascript await "$2") &> /dev/null
    elif [ "$1" != '--wait' ] && [ -n "$1" ]; then
      osascript connect "$1" &> /dev/null
    else
      usage "Not enough arguments." 
    fi 
    ;;
  disconnect|dis)
    if [ -n "$1" ]; then
      osascript disconnect "$1" &> /dev/null
    else
      osascript disconnect-all &> /dev/null
    fi
    ;;
  quit|q)
    osascript quit &> /dev/null
    ;;
  *)
    usage "Unexpected command: $command"
    ;;
esac 
